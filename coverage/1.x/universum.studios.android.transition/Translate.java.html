<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Translate.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">universum.studios.android.transition</a> &gt; <span class="el_source">Translate.java</span></div><h1>Translate.java</h1><pre class="source lang-java linenums">/*
 * =================================================================================================
 *                             Copyright (C) 2017 Universum Studios
 * =================================================================================================
 *         Licensed under the Apache License, Version 2.0 or later (further &quot;License&quot; only).
 * -------------------------------------------------------------------------------------------------
 * You may use this file only in compliance with the License. More details and copy of this License 
 * you may obtain at
 * 
 * 		http://www.apache.org/licenses/LICENSE-2.0
 * 
 * You can redistribute, modify or publish any part of the code written within this file but as it 
 * is described in the License, the software distributed under the License is distributed on an 
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES or CONDITIONS OF ANY KIND.
 * 
 * See the License for the specific language governing permissions and limitations under the License.
 * =================================================================================================
 */
package universum.studios.android.transition;

import android.animation.Animator;
import android.animation.AnimatorListenerAdapter;
import android.animation.ObjectAnimator;
import android.animation.TimeInterpolator;
import android.content.Context;
import android.content.res.Resources;
import android.content.res.TypedArray;
import android.graphics.Path;
import android.os.Build;
import android.support.annotation.IntDef;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.support.annotation.RequiresApi;
import android.support.annotation.VisibleForTesting;
import android.support.v4.view.animation.FastOutSlowInInterpolator;
import android.transition.Transition;
import android.transition.TransitionValues;
import android.transition.Visibility;
import android.util.AttributeSet;
import android.util.TypedValue;
import android.view.View;
import android.view.ViewGroup;

import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;

/**
 * A {@link Visibility} transition implementation that tracks changes to the visibility of target
 * views in the start and end scenes and translates/moves views in the scene. Visibility is
 * determined by both the {@link View#setVisibility(int)} state of the view as well as whether it
 * is parented in the current view hierarchy. Disappearing Views are limited as described in
 * {@link Visibility#onDisappear(android.view.ViewGroup, TransitionValues, int, TransitionValues, int)}.
 * &lt;p&gt;
 * This transition differs from {@link android.transition.Slide Slide} transition in a way that it
 * allows to translate a concrete view by a desired delta in both X and Y axes. The delta value by
 * which should be the view translated/moved may be specified either as fixed/absolute value or as
 * relative value to the the target view or to the scene where is the view presented. Delta values
 * for translate animation may be specified via {@link #setTranslationXDelta(float)} and
 * {@link #setTranslationYDelta(float)} and theirs &quot;relativity&quot; via {@link #setTranslationXRelativity(int)}
 * and {@link #setTranslationYRelativity(int)} where the specified relativity types will indicate
 * how the delta values should be treated.
 * &lt;p&gt;
 * Translate transition can be described in a resource file by using the {@code transition} tag with
 * {@code class} attribute set to {@code universum.studios.android.transition.Translate}, along with
 * Xml attributes referenced below.
 *
 * &lt;h3&gt;XML attributes&lt;/h3&gt;
 * {@link R.styleable#Ui_Transition_Translate Translate Attributes}
 *
 * @author Martin Albedinsky
 */
@RequiresApi(Build.VERSION_CODES.LOLLIPOP)
public class Translate extends Visibility {

	/*
	 * Constants ===================================================================================
	 */

	/**
	 * Log TAG.
	 */
	// private static final String TAG = &quot;Translation&quot;;

	/**
	 * Defines an annotation for determining set of allowed modes for Translate transition.
	 */
	@Retention(RetentionPolicy.SOURCE)
	@IntDef(flag = true, value = {MODE_IN, MODE_OUT})
	public @interface TranslateMode {
	}

	/**
	 * Name of the property holding position on screen for animating view in {@link TransitionValues}.
	 */
	@VisibleForTesting
<span class="fc" id="L96">	static final String PROPERTY_TRANSITION_LOCATION_ON_SCREEN = Translate.class.getName() + &quot;:transition.locationOnScreen&quot;;</span>

	/*
	 * Interface ===================================================================================
	 */

	/**
	 * DeltaResolver specifies an interface that may be used to resolve delta value for translate
	 * animation along both X and Y axes.
	 *
	 * @author Martin Albedinsky
	 */
	public interface DeltaResolver {

		/**
		 * Resolves proper delta value for translate animation along X axis for the specified parameters.
		 * &lt;p&gt;
		 * Implementations should always return absolute delta value in pixels calculated from the
		 * given value depending on the specified relativity.
		 *
		 * @param sceneRoot       Root view of the scene containing the target view in its view
		 *                        hierarchy for which the translate animation will be played.
		 * @param view            The target view for which will be the translate animation played.
		 * @param valueRelativity Relativity type describing how the given &lt;var&gt;value&lt;/var&gt; should
		 *                        be treated.
		 * @param value           Either absolute or relative delta value used to properly calculate
		 *                        the absolute delta depending on the specified &lt;var&gt;valueRelativity&lt;/var&gt;.
		 * @return Resolved translation delta value for X axis in pixels.
		 */
		float resolveDeltaX(@NonNull ViewGroup sceneRoot, @NonNull View view, @Description.ValueRelativity int valueRelativity, float value);

		/**
		 * Resolves proper delta value for translate animation along Y axis for the specified parameters.
		 * &lt;p&gt;
		 * Implementations should always return absolute delta value in pixels calculated from the
		 * given value depending on the specified relativity.
		 *
		 * @param sceneRoot       Root view of the scene containing the target view in its view
		 *                        hierarchy for which the translate animation will be played.
		 * @param view            The target view for which will be the translate animation played.
		 * @param valueRelativity Relativity type describing how the given &lt;var&gt;value&lt;/var&gt; should
		 *                        be treated.
		 * @param value           Either absolute or relative delta value used to properly calculate
		 *                        the absolute delta depending on the specified &lt;var&gt;valueRelativity&lt;/var&gt;.
		 * @return Resolved translation delta value for X axis in pixels.
		 */
		float resolveDeltaY(@NonNull ViewGroup sceneRoot, @NonNull View view, @Description.ValueRelativity int valueRelativity, float value);
	}

	/*
	 * Static members ==============================================================================
	 */

	/**
	 * Default interpolator attached to {@link Animator} created via {@link #createAnimator(Transition, View, TransitionValues, int, int, float, float, float, float)}.
	 */
<span class="fc" id="L152">	public static final TimeInterpolator INTERPOLATOR = new FastOutSlowInInterpolator();</span>

	/**
	 * Default implementation of {@link DeltaResolver} used to resolve translation delta values
	 * for {@link #onAppear(ViewGroup, TransitionValues, int, TransitionValues, int)} and
	 * {@link #onDisappear(ViewGroup, TransitionValues, int, TransitionValues, int)} methods.
	 */
<span class="fc" id="L159">	public static final DeltaResolver DELTA_RESOLVER = new DeltaResolver() {</span>

		/**
		 */
		@Override
		public float resolveDeltaX(@NonNull ViewGroup sceneRoot, @NonNull View view, @Description.ValueRelativity int valueRelativity, float value) {
<span class="fc" id="L165">			return resolveDelta(valueRelativity, value, sceneRoot.getWidth(), view.getWidth());</span>
		}

		/**
		 */
		@Override
		public float resolveDeltaY(@NonNull ViewGroup sceneRoot, @NonNull View view, @Description.ValueRelativity int valueRelativity, float value) {
<span class="fc" id="L172">			return resolveDelta(valueRelativity, value, sceneRoot.getHeight(), view.getHeight());</span>
		}

		/**
		 * Resolves delta value for translation based on the specified parameters.
		 *
		 * @param valueRelativity Relativity of the given &lt;var&gt;value&lt;/var&gt; determining how the value
		 *                        should be treated.
		 * @param value           Value from which to resolve translation delta.
		 * @param sceneSize       Size of the scene in which is presented the view to be translated.
		 * @param viewSize        Size of the view to be translated.
		 * @return Resolved translation delta according to the specified parameters.
		 */
		private float resolveDelta(@Description.ValueRelativity int valueRelativity, float value, int sceneSize, int viewSize) {
<span class="pc bpc" id="L186" title="2 of 3 branches missed.">			switch (valueRelativity) {</span>
				case Description.RELATIVE_TO_TARGET:
<span class="nc" id="L188">					return value * viewSize;</span>
				case Description.RELATIVE_TO_SCENE:
<span class="nc" id="L190">					return value * sceneSize;</span>
				case Description.NONE:
				default:
<span class="fc" id="L193">					return value;</span>
			}
		}
	};

	/*
	 * Members =====================================================================================
	 */

	/**
	 * Delta by which should be the target view translated/moved in the scene along X axis. This may
	 * be either a fixed/absolute value in pixels or a relative/fraction value determining how much
	 * should be the view moved relative to its size (width) or relative to the size (width) of the
	 * root scene.
	 * &lt;p&gt;
	 * Relativity of this value is described by {@link #mTranslationXRelativity} value.
	 */
	private float mTranslationXDelta;

	/**
	 * Delta by which should be the target view translated/moved in the scene along Y axis. This may
	 * be either a fixed/absolute value in pixels or a relative/fraction value determining how much
	 * should be the view moved relative to its size (height) or relative to the size (height) of the
	 * root scene.
	 * &lt;p&gt;
	 * Relativity of this value is described by {@link #mTranslationYRelativity} value.
	 */
	private float mTranslationYDelta;

	/**
	 * Relativity type describing how should be treated value specified for {@link #mTranslationXDelta}.
	 * See relativity types defined by {@link Description.ValueRelativity @ValueRelativity} annotation.
	 */
<span class="fc" id="L226">	private int mTranslationXRelativity = Description.NONE;</span>

	/**
	 * Relativity type describing how should be treated value specified for {@link #mTranslationYDelta}.
	 * See relativity types defined by {@link Description.ValueRelativity @ValueRelativity} annotation.
	 */
<span class="fc" id="L232">	private int mTranslationYRelativity = Description.NONE;</span>

	/*
	 * Constructors ================================================================================
	 */

	/**
	 * Same as {@link #Translate(int)} with both {@link #MODE_IN} and {@link #MODE_OUT} modes combined.
	 */
	public Translate() {
<span class="fc" id="L242">		super();</span>
<span class="fc" id="L243">	}</span>

	/**
	 * Creates a new instance of Translate transition with the specified &lt;var&gt;mode&lt;/var&gt;.
	 *
	 * @param mode One of {@link #MODE_IN} or {@link #MODE_OUT} or theirs combination.
	 */
	public Translate(@TranslateMode final int mode) {
<span class="fc" id="L251">		super();</span>
<span class="fc" id="L252">		setMode(mode);</span>
<span class="fc" id="L253">	}</span>

	/**
	 * Creates a new instance of Translate transition with animation property values set from the
	 * specified &lt;var&gt;attrs&lt;/var&gt;.
	 *
	 * @param context Context used to obtain values from the specified &lt;var&gt;attrs&lt;/var&gt;.
	 * @param attrs   Set of attributes from which to obtain animation property values for the scale
	 *                animation.
	 */
	public Translate(@NonNull final Context context, @Nullable final AttributeSet attrs) {
<span class="fc" id="L264">		super(context, attrs);</span>
<span class="fc" id="L265">		final Resources resources = context.getResources();</span>
<span class="fc" id="L266">		final TypedArray attributes = context.obtainStyledAttributes(attrs, R.styleable.Ui_Transition_Translate, 0, 0);</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">		for (int i = 0; i &lt; attributes.getIndexCount(); i++) {</span>
<span class="fc" id="L268">			final int index = attributes.getIndex(i);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">			if (index == R.styleable.Ui_Transition_Translate_uiTranslationXDelta) {</span>
<span class="fc" id="L270">				final Description description = Description.parseValue(resources, attributes.peekValue(index));</span>
<span class="fc" id="L271">				this.mTranslationXRelativity = description.valueRelativity;</span>
<span class="fc" id="L272">				this.mTranslationXDelta = description.value;</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">			} else if (index == R.styleable.Ui_Transition_Translate_uiTranslationYDelta) {</span>
<span class="fc" id="L274">				final Description description = Description.parseValue(resources, attributes.peekValue(index));</span>
<span class="fc" id="L275">				this.mTranslationYRelativity = description.valueRelativity;</span>
<span class="fc" id="L276">				this.mTranslationYDelta = description.value;</span>
			}
		}
<span class="fc" id="L279">		attributes.recycle();</span>
<span class="fc" id="L280">	}</span>

	/*
	 * Methods =====================================================================================
	 */

	/**
	 * Creates a new instance of Animator that animates both, translation X and translation Y, properties
	 * of the specified &lt;var&gt;view&lt;/var&gt; with respect to its current translation values.
	 * &lt;p&gt;
	 * The created animator also properly handles cases when the translate animation is interrupted,
	 * paused or canceled, and possibly resumed later.
	 * &lt;p&gt;
	 * The returned animator will also have the default {@link #INTERPOLATOR} attached.
	 *
	 * @param transition       The transition that was requested to animate the given &lt;var&gt;view&lt;/var&gt;.
	 * @param view             The view for which to create the requested animator.
	 * @param transitionValues Either start or end transition values containing view that is
	 *                         currently in the view hierarchy.
	 * @param viewX            Last known X position of the view on the screen captured by the transition.
	 * @param viewY            Last known Y position of the view on the screen captured by the transition.
	 * @param startX           Translation from which to start the animation along X axis.
	 * @param startY           Translation from which to start the animation along Y axis.
	 * @param endX             Translation at which should the animation end along X axis.
	 * @param endY             Translation at which should the animation end along Y axis.
	 * @return Animator that will play translate animation for the specified view according to the
	 * specified parameters when started or {@code null} if the start and end translation values are
	 * the same.
	 */
	@Nullable
	@SuppressWarnings(&quot;UnnecessaryLocalVariable&quot;)
	public static Animator createAnimator(
			@NonNull final Transition transition,
			@NonNull final View view,
			@NonNull final TransitionValues transitionValues,
			final int viewX,
			final int viewY,
			final float startX,
			final float startY,
			final float endX,
			final float endY
	) {
<span class="fc" id="L322">		float animationStartX = startX;</span>
<span class="fc" id="L323">		float animationStartY = startY;</span>
<span class="fc" id="L324">		final float animationEndX = endX;</span>
<span class="fc" id="L325">		final float animationEndY = endY;</span>
<span class="fc" id="L326">		final float viewEndX = view.getTranslationX();</span>
<span class="fc" id="L327">		final float viewEndY = view.getTranslationY();</span>
		// Correct animation start coordinates by view's position on screen.
<span class="fc" id="L329">		final int[] startPosition = (int[]) transitionValues.view.getTag(R.id.ui_transition_tag_position);</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">		if (startPosition != null) {</span>
<span class="fc" id="L331">			animationStartX = startPosition[0] - viewX + viewEndX;</span>
<span class="fc" id="L332">			animationStartY = startPosition[1] - viewY + viewEndY;</span>
		}
<span class="fc" id="L334">		view.setTranslationX(animationStartX);</span>
<span class="fc" id="L335">		view.setTranslationY(animationStartY);</span>
<span class="fc bfc" id="L336" title="All 4 branches covered.">		if (animationStartX == animationEndX &amp;&amp; animationStartY == animationEndY) {</span>
<span class="fc" id="L337">			return null;</span>
		}
<span class="fc" id="L339">		final int viewStartX = viewX + Math.round(startX - viewEndX);</span>
<span class="fc" id="L340">		final int viewStartY = viewY + Math.round(startY - viewEndY);</span>
		// Create path with animation properties and animator that will be used to play the desired
		// translate animation for the view.
<span class="fc" id="L343">		final Path path = new Path();</span>
<span class="fc" id="L344">		path.moveTo(animationStartX, animationStartY);</span>
<span class="fc" id="L345">		path.lineTo(animationEndX, animationEndY);</span>
<span class="fc" id="L346">		final ObjectAnimator animator = ObjectAnimator.ofFloat(view, View.TRANSLATION_X, View.TRANSLATION_Y, path);</span>
<span class="fc" id="L347">		final TransitionAnimatorListener listener = new TransitionAnimatorListener(</span>
				view,
				transitionValues.view,
				viewStartX, viewStartY,
				viewEndX, viewEndY
		);
<span class="fc" id="L353">		transition.addListener(listener);</span>
<span class="fc" id="L354">		animator.addListener(listener);</span>
<span class="fc" id="L355">		animator.addPauseListener(listener);</span>
<span class="fc" id="L356">		animator.setInterpolator(INTERPOLATOR);</span>
<span class="fc" id="L357">		return animator;</span>
	}

	/**
	 * Sets a delta value by which should be the target view translated/moved in or out, absolutely
	 * or relatively, in the scene along X axis. This may be either a fixed/absolute value in pixels
	 * or a relative/fraction value determining how much should be the view moved relative to its
	 * size (width) or relative to the size (width) of the root scene.
	 * &lt;p&gt;
	 * Relativity of this value may be changed via {@link #setTranslationXRelativity(int)}.
	 * &lt;p&gt;
	 * Default value: {@code 0}
	 *
	 * @param xDelta The desired delta. If the delta will represent a relative fraction value, the
	 *               specified value should be from the range {@code [0.0, 1.0]}.
	 * @see R.attr#uiTranslationXDelta ui:uiTranslationXDelta
	 * @see #getTranslationXDelta()
	 * @see #getTranslationXRelativity()
	 */
	public void setTranslationXDelta(float xDelta) {
<span class="fc" id="L377">		this.mTranslationXDelta = xDelta;</span>
<span class="fc" id="L378">	}</span>

	/**
	 * Returns the delta by which should be the target view translated/moved in the root scene along
	 * X axis.
	 *
	 * @return Delta value for translation along X axis.
	 * @see #setTranslationXDelta(float)
	 */
	public float getTranslationXDelta() {
<span class="fc" id="L388">		return mTranslationXDelta;</span>
	}

	/**
	 * Sets a delta value by which should be the target view translated/moved in or out, absolutely
	 * or relatively, in the scene along Y axis. This may be either a fixed/absolute value in pixels
	 * or a relative/fraction value determining how much should be the view moved relative to its
	 * size (height) or relative to the size (height) of the root scene.
	 * &lt;p&gt;
	 * Relativity of this value may be changed via {@link #setTranslationYRelativity(int)}.
	 * &lt;p&gt;
	 * Default value: {@code 0}
	 *
	 * @param yDelta The desired delta. If the delta will represent a relative fraction value, the
	 *               specified value should be from the range {@code [0.0, 1.0]}.
	 * @see R.attr#uiTranslationYDelta ui:uiTranslationYDelta
	 * @see #getTranslationYDelta()
	 * @see #getTranslationYRelativity()
	 */
	public void setTranslationYDelta(float yDelta) {
<span class="fc" id="L408">		this.mTranslationYDelta = yDelta;</span>
<span class="fc" id="L409">	}</span>

	/**
	 * Returns the delta by which should be the target view translated/moved in the root scene along
	 * Y axis.
	 *
	 * @return Delta value for translation along Y axis.
	 * @see #setTranslationYDelta(float)
	 */
	public float getTranslationYDelta() {
<span class="fc" id="L419">		return mTranslationYDelta;</span>
	}

	/**
	 * Sets a relativity type that describes how should be treated delta value for translation along
	 * X axis specified via {@link #setTranslationXDelta(float)}. See {@link Description} for more
	 * information about supported relativity types and also how to choose a desired one.
	 * &lt;p&gt;
	 * Default value: {@link Description#NONE}
	 *
	 * @param xRelativity The desired relativity type. One of types defined by
	 *                    {@link Description.ValueRelativity @ValueRelativity} annotation.
	 * @see R.attr#uiTranslationXDelta ui:uiTranslationXDelta
	 * @see #getTranslationXRelativity()
	 */
	public void setTranslationXRelativity(@Description.ValueRelativity final int xRelativity) {
<span class="fc" id="L435">		this.mTranslationXRelativity = xRelativity;</span>
<span class="fc" id="L436">	}</span>

	/**
	 * Returns the relativity type describing value returned by {@link #getTranslationXDelta()}.
	 *
	 * @return Relativity of delta value for translation along X axis.
	 * @see #setTranslationXRelativity(int)
	 */
	@Description.ValueRelativity
	public int getTranslationXRelativity() {
<span class="fc" id="L446">		return mTranslationXRelativity;</span>
	}

	/**
	 * Sets a relativity type that describes how should be treated delta value for translation along
	 * Y axis specified via {@link #setTranslationYDelta(float)}. See {@link Description} for more
	 * information about supported relativity types and also how to choose a desired one.
	 * &lt;p&gt;
	 * Default value: {@link Description#NONE}
	 *
	 * @param yRelativity The desired relativity type. One of types defined by
	 *                    {@link Description.ValueRelativity @ValueRelativity} annotation.
	 * @see R.attr#uiTranslationYDelta ui:uiTranslationYDelta
	 * @see #getTranslationYRelativity()
	 */
	public void setTranslationYRelativity(@Description.ValueRelativity final int yRelativity) {
<span class="fc" id="L462">		this.mTranslationYRelativity = yRelativity;</span>
<span class="fc" id="L463">	}</span>

	/**
	 * Returns the relativity type describing value returned by {@link #getTranslationYDelta()}.
	 *
	 * @return Relativity of delta value for translation along Y axis.
	 * @see #setTranslationYRelativity(int)
	 */
	@Description.ValueRelativity
	public int getTranslationYRelativity() {
<span class="fc" id="L473">		return mTranslationYRelativity;</span>
	}

	/**
	 */
	@Override
	public void captureStartValues(@NonNull final TransitionValues transitionValues) {
<span class="fc" id="L480">		super.captureStartValues(transitionValues);</span>
<span class="fc" id="L481">		this.captureValues(transitionValues);</span>
<span class="fc" id="L482">	}</span>

	/**
	 */
	@Override
	public void captureEndValues(@NonNull final TransitionValues transitionValues) {
<span class="fc" id="L488">		super.captureEndValues(transitionValues);</span>
<span class="fc" id="L489">		this.captureValues(transitionValues);</span>
<span class="fc" id="L490">	}</span>

	/**
	 * Captures current location on screen for the view attached to the specified values and puts
	 * such value into the values map.
	 *
	 * @param values The values where to put captured values.
	 */
	private void captureValues(final TransitionValues values) {
<span class="fc" id="L499">		final int[] locationOnScreen = new int[2];</span>
<span class="fc" id="L500">		values.view.getLocationOnScreen(locationOnScreen);</span>
<span class="fc" id="L501">		values.values.put(PROPERTY_TRANSITION_LOCATION_ON_SCREEN, locationOnScreen);</span>
<span class="fc" id="L502">	}</span>

	/**
	 */
	@Override
	public Animator onAppear(
			@NonNull final ViewGroup sceneRoot,
			@NonNull final View view,
			@Nullable final TransitionValues startValues,
			@Nullable final TransitionValues endValues
	) {
<span class="fc bfc" id="L513" title="All 2 branches covered.">		if (endValues == null) {</span>
<span class="fc" id="L514">			return null;</span>
		}
<span class="fc" id="L516">		final int[] locationOnScreen = (int[]) endValues.values.get(PROPERTY_TRANSITION_LOCATION_ON_SCREEN);</span>
<span class="fc bfc" id="L517" title="All 2 branches covered.">		if (locationOnScreen == null) {</span>
<span class="fc" id="L518">			return null;</span>
		}
<span class="fc" id="L520">		final float endX = view.getTranslationX();</span>
<span class="fc" id="L521">		final float endY = view.getTranslationY();</span>
<span class="fc" id="L522">		final float startX = endX + DELTA_RESOLVER.resolveDeltaX(sceneRoot, view, mTranslationXRelativity, mTranslationXDelta);</span>
<span class="fc" id="L523">		final float startY = endY + DELTA_RESOLVER.resolveDeltaY(sceneRoot, view, mTranslationYRelativity, mTranslationYDelta);</span>
<span class="fc" id="L524">		return createAnimator(</span>
				this,
				view,
				endValues,
				locationOnScreen[0], locationOnScreen[1],
				startX, startY,
				endX, endY
		);
	}

	/**
	 */
	@Override
	public Animator onDisappear(
			@NonNull final ViewGroup sceneRoot,
			@NonNull final View view,
			@Nullable final TransitionValues startValues,
			@Nullable final TransitionValues endValues
	) {
<span class="fc bfc" id="L543" title="All 2 branches covered.">		if (startValues == null) {</span>
<span class="fc" id="L544">			return null;</span>
		}
<span class="fc" id="L546">		final int[] locationOnScreen = (int[]) startValues.values.get(PROPERTY_TRANSITION_LOCATION_ON_SCREEN);</span>
<span class="fc bfc" id="L547" title="All 2 branches covered.">		if (locationOnScreen == null) {</span>
<span class="fc" id="L548">			return null;</span>
		}
<span class="fc" id="L550">		final float startX = view.getTranslationX();</span>
<span class="fc" id="L551">		final float startY = view.getTranslationY();</span>
<span class="fc" id="L552">		final float endX = startX + DELTA_RESOLVER.resolveDeltaX(sceneRoot, view, mTranslationXRelativity, mTranslationXDelta);</span>
<span class="fc" id="L553">		final float endY = startY + DELTA_RESOLVER.resolveDeltaY(sceneRoot, view, mTranslationYRelativity, mTranslationYDelta);</span>
<span class="fc" id="L554">		return createAnimator(</span>
				this,
				view,
				startValues,
				locationOnScreen[0], locationOnScreen[1],
				startX, startY,
				endX, endY
		);
	}

	/*
	 * Inner classes ===============================================================================
	 */

	/**
	 * Describes a translation delta value specified via one of {@link R.attr#uiTranslationXDelta uiTranslationXDelta},
	 * {@link R.attr#uiTranslationYDelta uiTranslationYDelta} attributes.
	 *
	 * @author Martin Albedinsky
	 */
	public static final class Description {

		/**
		 * Constant used to identify that {@link Description#value} should be treated as absolute
		 * (float or dimension) value and not as relative one.
		 */
		public static final int NONE = 0x00;

		/**
		 * Constant used to identify that {@link Description#value} should be treated as relative
		 * fraction to the target view (its size) to be translated.
		 */
		public static final int RELATIVE_TO_TARGET = 0x01;

		/**
		 * Constant used to identify that {@link Description#value} should be treated as relative
		 * fraction to the scene root (its size) where the target view to be animated is presented.
		 */
		public static final int RELATIVE_TO_SCENE = 0x02;

		/**
		 * Defines an annotation for determining set of supported relativity types for translation
		 * delta value of Translate transition.
		 */
		@IntDef({NONE, RELATIVE_TO_TARGET, RELATIVE_TO_SCENE})
		@Retention(RetentionPolicy.SOURCE)
		public @interface ValueRelativity {
		}

		/**
		 * Relativity type parsed for this value description. One of types defined by
		 * {@link ValueRelativity @ValueRelativity} annotation.
		 *
		 * @see #parseValue(Resources, TypedValue)
		 */
		@ValueRelativity
		public final int valueRelativity;

		/**
		 * Value parsed for this description. This is either absolute value (float or dimension pixel
		 * size) or a fraction that should be treated relatively to either target view or scene root
		 * depending on {@link #valueRelativity} type.
		 *
		 * @see #parseValue(Resources, TypedValue)
		 */
		public final float value;

		/**
		 * Creates a new instance of Description with the specified &lt;var&gt;valueRelativity&lt;/var&gt; and
		 * &lt;var&gt;value&lt;/var&gt;.
		 *
		 * @param valueRelativity The value relativity type for the new description.
		 * @param value           The value for the new description.
		 */
<span class="fc" id="L628">		private Description(@ValueRelativity final int valueRelativity, final float value) {</span>
<span class="fc" id="L629">			this.valueRelativity = valueRelativity;</span>
<span class="fc" id="L630">			this.value = value;</span>
<span class="fc" id="L631">		}</span>

		/**
		 * Parses a new Description with translation delta value and value relativity type from the
		 * given &lt;var&gt;typedValue&lt;/var&gt;.
		 *
		 * @param resources  Resources used to properly parse value type of &lt;b&gt;dimension&lt;/b&gt;.
		 * @param typedValue Typed value containing translation delta value to be parsed.
		 * @return Description with value and relativity type parsed from the given &lt;var&gt;typedValue&lt;/var&gt;.
		 */
		@NonNull
		public static Description parseValue(@NonNull Resources resources, @Nullable TypedValue typedValue) {
<span class="fc" id="L643">			int valueRelativity = NONE;</span>
<span class="fc" id="L644">			float value = 0;</span>
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">			if (typedValue != null) {</span>
<span class="pc bpc" id="L646" title="2 of 4 branches missed.">				switch (typedValue.type) {</span>
					case TypedValue.TYPE_FLOAT:
<span class="nc" id="L648">						value = typedValue.getFloat();</span>
<span class="nc" id="L649">						break;</span>
					case TypedValue.TYPE_DIMENSION:
<span class="fc" id="L651">						value = TypedValue.complexToDimensionPixelSize(typedValue.data, resources.getDisplayMetrics());</span>
<span class="fc" id="L652">						break;</span>
					case TypedValue.TYPE_FRACTION:
<span class="fc bfc" id="L654" title="All 2 branches covered.">						valueRelativity = (typedValue.data &amp; TypedValue.COMPLEX_UNIT_MASK) == TypedValue.COMPLEX_UNIT_FRACTION_PARENT ?</span>
								RELATIVE_TO_SCENE :
								RELATIVE_TO_TARGET;
<span class="fc" id="L657">						value = TypedValue.complexToFloat(typedValue.data);</span>
<span class="fc" id="L658">						break;</span>
					default:
<span class="nc bnc" id="L660" title="All 4 branches missed.">						if (typedValue.type &gt;= TypedValue.TYPE_FIRST_INT &amp;&amp; typedValue.type &lt;= TypedValue.TYPE_LAST_INT) {</span>
<span class="nc" id="L661">							value = typedValue.data;</span>
						}
						break;
				}
			}
<span class="fc" id="L666">			return new Description(valueRelativity, value);</span>
		}
	}

	/**
	 * Listener that is used by {@link Translate} transition to change properties of the animating
	 * view according to the received animation callbacks.
	 */
	@VisibleForTesting
	static final class TransitionAnimatorListener extends AnimatorListenerAdapter implements TransitionListener {

		/**
		 * View of which properties to change due to received animation callbacks.
		 */
		private final View animatingView;

		/**
		 * Static (not animating) view that is currently in a view hierarchy.
		 */
		private final View staticView;

		/**
		 * Pair of current positions of translate animation.
		 */
		private int[] animationPosition;

		/**
		 * Position where should the translate animation start along X axis.
		 */
		private final float startX;

		/**
		 * Position at which should the translate animation start along Y axis.
		 */
		private final float startY;

		/**
		 * Position at which was the translate animation paused along X axis.
		 */
		private float pausedX;

		/**
		 * Position at which was the translate animation paused along Y axis.
		 */
		private float pausedY;

		/**
		 * Position at which should the translate animation end along X axis.
		 */
		private final float endX;

		/**
		 * Position at which should the translate animation end along Y axis.
		 */
		private final float endY;

		/**
		 * Creates a new instance of TransitionAnimatorListener with the specified views and translate
		 * animation properties.
		 *
		 * @param animatingView The animating view of which properties may be changed by the
		 *                      animator listener as result of received animation callbacks.
		 * @param staticView    Static (not animating) view that is currently in a view hierarchy.
		 * @param startX        Start position of the translate animation along X axis.
		 * @param startY        Start position of the translate animation along Y axis.
		 * @param endX          End position of the translate animation along X axis.
		 * @param endY          End position of the translate animation along Y axis.
		 */
		TransitionAnimatorListener(
				View animatingView,
				View staticView,
				float startX,
				float startY,
				float endX,
				float endY
		) {
<span class="fc" id="L742">			super();</span>
<span class="fc" id="L743">			this.animatingView = animatingView;</span>
<span class="fc" id="L744">			this.staticView = staticView;</span>
<span class="fc" id="L745">			this.startX = startX - Math.round(animatingView.getTranslationX());</span>
<span class="fc" id="L746">			this.startY = startY - Math.round(animatingView.getTranslationY());</span>
<span class="fc" id="L747">			this.endX = endX;</span>
<span class="fc" id="L748">			this.endY = endY;</span>
<span class="fc" id="L749">			this.animationPosition = (int[]) staticView.getTag(R.id.ui_transition_tag_position);</span>
<span class="fc bfc" id="L750" title="All 2 branches covered.">			if (animationPosition != null) {</span>
<span class="fc" id="L751">				staticView.setTag(R.id.ui_transition_tag_position, null);</span>
			}
<span class="fc" id="L753">		}</span>

		/**
		 */
		@Override
		public void onAnimationCancel(Animator animation) {
<span class="pc bpc" id="L759" title="1 of 2 branches missed.">			if (animationPosition == null) {</span>
<span class="nc" id="L760">				this.animationPosition = new int[2];</span>
			}
<span class="fc" id="L762">			this.animationPosition[0] = Math.round(startX + animatingView.getTranslationX());</span>
<span class="fc" id="L763">			this.animationPosition[1] = Math.round(startY + animatingView.getTranslationY());</span>
<span class="fc" id="L764">			this.staticView.setTag(R.id.ui_transition_tag_position, animationPosition);</span>
<span class="fc" id="L765">		}</span>

		/**
		 */
		@Override
		public void onAnimationPause(Animator animation) {
<span class="fc" id="L771">			this.pausedX = animatingView.getTranslationX();</span>
<span class="fc" id="L772">			this.pausedY = animatingView.getTranslationY();</span>
<span class="fc" id="L773">			this.animatingView.setTranslationX(endX);</span>
<span class="fc" id="L774">			this.animatingView.setTranslationY(endY);</span>
<span class="fc" id="L775">		}</span>

		/**
		 */
		@Override
		public void onAnimationResume(Animator animation) {
<span class="fc" id="L781">			this.animatingView.setTranslationX(pausedX);</span>
<span class="fc" id="L782">			this.animatingView.setTranslationY(pausedY);</span>
<span class="fc" id="L783">		}</span>

		/**
		 */
		@Override
		public void onTransitionStart(@NonNull final Transition transition) {
			// Ignored.
<span class="fc" id="L790">		}</span>

		/**
		 */
		@Override
		public void onTransitionEnd(@NonNull final Transition transition) {
<span class="fc" id="L796">			this.animatingView.setTranslationX(endX);</span>
<span class="fc" id="L797">			this.animatingView.setTranslationY(endY);</span>
<span class="fc" id="L798">		}</span>

		/**
		 */
		@Override
		public void onTransitionCancel(@NonNull final Transition transition) {
			// Ignored.
<span class="fc" id="L805">		}</span>

		/**
		 */
		@Override
		public void onTransitionPause(@NonNull final Transition transition) {
			// Ignored.
<span class="fc" id="L812">		}</span>

		/**
		 */
		@Override
		public void onTransitionResume(@NonNull final Transition transition) {
			// Ignored.
<span class="fc" id="L819">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.2</div></body></html>